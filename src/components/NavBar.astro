---
import { withBase, basePath } from '../utils/url';
import ThemeToggle from './ThemeToggle.astro';

const links = [
  { href: '/', label: 'Home' },
  { href: '/projects', label: 'Projects' },
  { href: '/about', label: 'About' },
  { href: '/contact', label: 'Contact' },
];

const rawPath = Astro.url.pathname.replace(/\/?$/, '') || '/';
const effectiveBase = basePath || '';
const pathname = effectiveBase && rawPath.startsWith(effectiveBase) ? rawPath.slice(effectiveBase.length) || '/' : rawPath || '/';
---
<header class="pointer-events-auto sticky top-0 z-30 px-4 pt-6 sm:px-10 lg:px-16">
  <div class="frosted-panel relative flex items-center justify-between border border-white/5 px-5 py-4">
    <div class="pointer-events-none absolute inset-0 rounded-[28px] border border-white/5 opacity-30"></div>
    <a href={withBase('/')} class="relative z-10 flex items-center gap-3" aria-label="Thomas Patsanis home">
      <span
        class="grid h-12 w-12 place-items-center rounded-2xl border border-[var(--border-strong)] bg-surface/40 font-display text-lg font-semibold text-[var(--text)] shadow-brass-ring"
      >
        TP
      </span>
      <div>
        <p class="text-[11px] uppercase tracking-[0.7em] text-[var(--muted)]">Thomas Patsanis</p>
        <p class="text-xs text-[var(--muted)]">Full-Stack Explorer</p>
      </div>
    </a>
    <nav class="absolute left-1/2 top-1/2 z-10 hidden -translate-x-1/2 -translate-y-1/2 items-center gap-6 text-xs font-semibold uppercase tracking-[0.35em] text-[var(--muted)] lg:flex">
      {links.map((link) => (
        <a
          href={withBase(link.href)}
          class={`group relative pb-2 transition-colors ${pathname === link.href ? 'text-[var(--accent)]' : 'hover:text-[var(--accent)]'}`}
        >
          {link.label}
          <span
            class={`absolute left-1/2 top-full h-px w-8 -translate-x-1/2 bg-gradient-to-r from-transparent via-[var(--brass)] to-transparent transition-opacity ${pathname === link.href ? 'opacity-100' : 'opacity-0 group-hover:opacity-70'}`}
          ></span>
        </a>
      ))}
    </nav>
    <div class="relative z-10 flex items-center gap-3">
      <ThemeToggle />
      <button class="lg:hidden" id="nav-toggle" aria-expanded="false" aria-controls="mobile-menu" type="button">
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl border border-[var(--border)] bg-surface/20 text-[var(--text)]">
          <span class="sr-only">Toggle navigation</span>
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h16" />
          </svg>
        </div>
      </button>
    </div>
  </div>
  <div id="mobile-nav-overlay" class="mobile-nav-overlay fixed inset-0 z-40 bg-[var(--bg)]/70 backdrop-blur-sm transition-opacity lg:hidden" data-open="false" aria-hidden="true"></div>
  <div
    id="mobile-menu"
    data-open="false"
    class="mobile-menu-panel frosted-panel fixed inset-x-4 top-24 z-50 mt-3 flex max-h-[calc(100vh-8rem)] flex-col gap-5 overflow-y-auto border border-white/10 px-6 py-6 text-center text-sm font-semibold uppercase tracking-[0.35em] text-[var(--muted)] lg:hidden"
  >
    {links.map((link) => (
      <a
        href={withBase(link.href)}
        class={`pb-1 text-base tracking-[0.4em] text-[var(--muted)] transition-colors ${pathname === link.href ? 'text-[var(--accent)]' : 'hover:text-[var(--accent)]'}`}
      >
        {link.label}
      </a>
    ))}
    <div class="mt-2 grid grid-cols-2 gap-3 text-[10px] uppercase tracking-[0.4em] text-[var(--muted)]">
      <a href={withBase('/contact')} class="rounded-2xl border border-[var(--border)] bg-surface/30 py-3 text-center text-[var(--text)]">Contact</a>
      <a href={withBase('/projects')} class="rounded-2xl border border-[var(--border)] bg-surface/30 py-3 text-center text-[var(--text)]">Projects</a>
    </div>
  </div>
  <script type="module" is:inline>
    const toggle = document.getElementById('nav-toggle');
    const menu = document.getElementById('mobile-menu');
    const overlay = document.getElementById('mobile-nav-overlay');

    const setMenuState = (open) => {
      if (!menu || !toggle || !overlay) return;
      menu.setAttribute('data-open', open ? 'true' : 'false');
      overlay.setAttribute('data-open', open ? 'true' : 'false');
      toggle.setAttribute('aria-expanded', open.toString());
      document.body.classList.toggle('overflow-hidden', open);
    };

    const isMenuOpen = () => menu?.getAttribute('data-open') === 'true';
    const closeMenu = () => setMenuState(false);
    const toggleMenu = () => setMenuState(!isMenuOpen());

    toggle?.addEventListener('click', () => toggleMenu());
    overlay?.addEventListener('click', () => closeMenu());
    menu?.querySelectorAll('a').forEach((link) => link.addEventListener('click', () => closeMenu()));

    window.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && isMenuOpen()) {
        closeMenu();
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1024 && isMenuOpen()) {
        closeMenu();
      }
    });
  </script>
</header>
